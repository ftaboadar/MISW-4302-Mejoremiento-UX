@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam activityBackgroundColor #FFCDD2
skinparam activityBorderColor #D32F2F
skinparam activityFontSize 12
skinparam arrowColor #D32F2F

title Flujo 9: Manejo de P√©rdida de Conexi√≥n (Offline) - App M√≥vil

start

:Usuario usando app;
:Conexi√≥n a internet se pierde;

partition "Detecci√≥n de P√©rdida" {
  :Sistema detecta p√©rdida de conexi√≥n;
  :Timestamp de desconexi√≥n;
  
  :Mostrar banner discreto:
  "üì∂ Sin conexi√≥n - Trabajando offline";
  
  :Banner no intrusivo:
  - Parte superior
  - Color neutro
  - No bloquea contenido
  - Se puede cerrar;
  
  note right
    Usuario puede seguir
    usando la app normalmente
  end note
}

partition "Funcionalidad Offline" {
  :App cambia a modo offline;
  
  :Funciones DISPONIBLES offline;
  
  :‚úÖ Confirmar toma de medicamento;
  :Guardar en cola local;
  :Marcar timestamp local;
  :Actualizar UI inmediatamente;
  
  :‚úÖ Ver historial de adherencia;
  :Cargar datos desde cache;
  :Mostrar datos hasta √∫ltima sync;
  :Indicador "Datos del [fecha/hora]";
  
  :‚úÖ Agregar medicamento;
  :Permitir ingreso manual;
  :Guardar en base datos local;
  :Deshabilitar escaneo (requiere API);
  :Deshabilitar OCR (requiere API);
  
  :‚úÖ Modificar horarios;
  :Cambios guardados localmente;
  :Reprogramar alarmas locales;
  
  :‚úÖ Ver estad√≠sticas;
  :Calcular con datos locales;
  :Mostrar hasta √∫ltima sync;
  
  :Funciones NO DISPONIBLES offline;
  
  :‚ùå Verificar interacciones medicamentosas;
  :Mostrar mensaje:
  "‚ö†Ô∏è Verificaci√≥n de interacciones
  requiere conexi√≥n a internet.
  El medicamento se guardar√° pero
  verifica interacciones al reconectar.";
  
  :‚ùå Escanear c√≥digo de barras;
  :Bot√≥n deshabilitado;
  :Tooltip: "Requiere conexi√≥n";
  
  :‚ùå OCR de receta;
  :Bot√≥n deshabilitado;
  :Tooltip: "Requiere conexi√≥n";
  
  :‚ùå Vincular con m√©dico;
  :Pantalla muestra:
  "Esta funci√≥n requiere
  conexi√≥n a internet";
  
  :‚ùå Sincronizar con dashboard m√©dico;
  :Datos no se env√≠an en tiempo real;
  :Se enviar√°n al reconectar;
}

partition "Cola de Sincronizaci√≥n" {
  :Sistema mantiene cola de acciones;
  
  :Lista de operaciones pendientes:
  1. Confirmaci√≥n toma (timestamp)
  2. Medicamento agregado (datos)
  3. Horario modificado (cambios)
  4. Registro editado (nueva data)
  5. Medicamento eliminado (ID);
  
  :Almacenar en SQLite local;
  :Persistir entre cierres de app;
  
  :UI muestra indicador:
  "üîÑ [N] acciones pendientes de sync";
  
  note right
    Usuario sabe que hay
    cambios sin sincronizar
  end note
}

partition "Detecci√≥n de Reconexi√≥n" {
  :App detecta conexi√≥n restaurada;
  
  :Evento de red: ONLINE;
  
  :Banner actualizado:
  "üì∂ Conexi√≥n restaurada - Sincronizando...";
  
  :Color cambia a azul/verde;
  :Animaci√≥n de progreso;
}

partition "Proceso de Sincronizaci√≥n" {
  :Iniciar sincronizaci√≥n autom√°tica;
  
  :Paso 1: Descargar datos servidor;
  :Obtener √∫ltimas actualizaciones:
  - Medicamentos modificados desde servidor
  - Nuevas alertas
  - Cambios en vinculaciones;
  
  :Paso 2: Detectar conflictos;
  
  if (¬øHay conflictos?) then (S√≠)
    partition "Resoluci√≥n de Conflictos" {
      :Tipo de conflicto detectado;
      
      if (¬øTipo?) then (Mismo registro editado)
        :Comparar timestamps;
        
        if (¬øCu√°l es m√°s reciente?) then (Local)
          :Priorizar cambios locales;
          :Enviar al servidor;
          :Actualizar servidor con versi√≥n local;
          
        else (Servidor)
          :Priorizar cambios servidor;
          :Actualizar local con versi√≥n servidor;
          
          :Notificar al usuario:
          "‚ÑπÔ∏è Algunos datos fueron
          actualizados desde el servidor
          mientras estabas offline";
        endif
        
      elseif (Medicamento eliminado en servidor) then
        :Verificar si usuario lo modific√≥ local;
        
        if (¬øModificado localmente?) then (S√≠)
          :Mostrar di√°logo:
          "‚ö†Ô∏è Conflicto detectado
          
          Este medicamento fue eliminado
          pero t√∫ lo modificaste offline.
          
          ¬øQu√© deseas hacer?
          - Mantener tus cambios
          - Eliminar el medicamento";
          
          :Usuario decide;
        else (No)
          :Eliminar de local autom√°ticamente;
        endif
        
      else (Otros conflictos)
        :Pol√≠tica: Timestamp m√°s reciente gana;
        :Aplicar cambios;
        :Registrar en log de auditor√≠a;
      endif
    }
  endif
  
  :Paso 3: Enviar cambios locales;
  
  :Procesar cola de operaciones:
  1. Ordenar por timestamp
  2. Agrupar por tipo
  3. Enviar por lotes;
  
  :Por cada operaci√≥n;
  
  if (¬øOperaci√≥n exitosa?) then (S√≠)
    :Marcar como sincronizada ‚úì;
    :Eliminar de cola;
    :Actualizar contador;
    
  else (Error)
    :Registrar error;
    :Mantener en cola;
    :Incrementar contador de reintentos;
    
    if (¬øReintentos > 3?) then (S√≠)
      :Mostrar alerta al usuario:
      "‚ö†Ô∏è No se pudo sincronizar
      [tipo de acci√≥n]
      
      Raz√≥n: [mensaje de error]
      
      Opciones:
      - Reintentar ahora
      - Descartar cambios
      - Intentar m√°s tarde";
      
      :Usuario decide;
    endif
  endif
  
  :Paso 4: Verificar integridad;
  
  :Comparar checksums;
  :Validar consistencia datos;
  
  if (¬øDatos √≠ntegros?) then (No)
    :Forzar sync completa;
    :Descargar todo desde servidor;
    :Actualizar base datos local;
  endif
}

partition "Finalizaci√≥n" {
  :Todas las operaciones procesadas;
  
  :Banner actualizado:
  "‚úì Todo actualizado";
  
  :Duraci√≥n: 3 segundos;
  :Luego se oculta autom√°ticamente;
  
  :Contador vuelve a 0:
  "üîÑ 0 acciones pendientes";
  
  :App en modo online normal;
  :Todas las funciones disponibles;
}

partition "Caso Especial: Offline Prolongado" {
  if (¬øOffline > 24 horas?) then (S√≠)
    :Mostrar advertencia:
    "‚ö†Ô∏è Sin conexi√≥n por m√°s de 24h
    
    Algunas funciones est√°n limitadas:
    - No se verifica interacciones
    - Dashboard m√©dico desactualizado
    - Datos podr√≠an estar obsoletos
    
    Conecta a internet cuando puedas";
    
    if (¬øOffline > 7 d√≠as?) then (S√≠)
      :Advertencia cr√≠tica:
      "‚ö†Ô∏è ATENCI√ìN
      
      Llevas m√°s de 7 d√≠as sin conexi√≥n.
      
      - Tus datos no est√°n sincronizados
      - Tu m√©dico no ve tu adherencia
      - Podr√≠as perder informaci√≥n
      
      Es cr√≠tico que te conectes pronto";
      
      :Ofrecer diagnosticar problema;
    endif
  endif
}

partition "Monitoreo de Calidad" {
  :Sistema registra m√©tricas:
  - Duraci√≥n offline
  - Cantidad de operaciones en cola
  - Conflictos detectados
  - Errores de sincronizaci√≥n
  - Tiempo de sincronizaci√≥n;
  
  :Enviar analytics (cuando online);
  :Usar para mejorar el sistema;
}

:Proceso completado;
:Usuario contin√∫a usando app;

stop

@enduml
