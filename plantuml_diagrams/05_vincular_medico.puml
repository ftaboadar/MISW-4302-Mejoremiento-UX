@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam activityBackgroundColor #E1F5FE
skinparam activityBorderColor #0277BD
skinparam activityFontSize 12
skinparam arrowColor #0277BD

title Flujo 5: Vincular con M√©dico - App M√≥vil (Paciente)

start

:Usuario en Home o Perfil;
:Tap "Vincular con m√©dico";

:Pantalla Vinculaci√≥n M√©dico;
:Mostrar explicaci√≥n:
"Comparte tu adherencia con tu m√©dico
para mejor seguimiento de tu tratamiento";

if (¬øUsuario tiene c√≥digo?) then (S√≠)
  partition "Flujo con C√≥digo" {
    :Campo de texto c√≥digo;
    :Placeholder: "MED-XXXX-XXXX";
    
    :Usuario ingresa c√≥digo;
    
    if (¬øFormato v√°lido?) then (No)
      :Mostrar error:
      "Formato de c√≥digo inv√°lido.
      Debe ser MED-XXXX-XXXX";
      stop
    endif
    
    :Validar c√≥digo con servidor;
    
    if (¬øC√≥digo existe y v√°lido?) then (No)
      :Mostrar error;
      
      if (¬øC√≥digo expir√≥?) then (S√≠)
        :Error: "Este c√≥digo expir√≥.
        Los c√≥digos son v√°lidos por 30 d√≠as.
        Solicita uno nuevo a tu m√©dico";
        
      elseif (¬øC√≥digo ya usado?) then (S√≠)
        :Error: "Este c√≥digo ya fue utilizado.
        Cada c√≥digo solo puede usarse una vez.
        Solicita uno nuevo a tu m√©dico";
        
      else (No existe)
        :Error: "C√≥digo no encontrado.
        Verifica que lo hayas ingresado
        correctamente";
      endif
      
      :Ofrecer opciones:
      1. Intentar de nuevo
      2. Enviar mensaje a m√©dico;
      stop
    endif
    
    :C√≥digo validado ‚úì;
    :Obtener datos del m√©dico;
    
    :Pantalla Confirmaci√≥n M√©dico;
    :Mostrar tarjeta con:
    - Foto profesional
    - Nombre completo Dr./Dra.
    - Especialidad
    - Instituci√≥n/Cl√≠nica
    - N√∫mero registro m√©dico;
    
    :Pregunta:
    "¬øEs este tu m√©dico?";
    
    if (¬øUsuario confirma?) then (No)
      :Cancelar proceso;
      :Sugerir verificar c√≥digo
      con el m√©dico;
      stop
    endif
    
    :Usuario confirma vinculaci√≥n;
    :Enviar solicitud al m√©dico;
    
    :Pantalla Solicitud Enviada;
    :Mensaje:
    "‚úì Solicitud enviada a Dr./Dra. [Nombre]
    Te notificaremos cuando acepte
    tu solicitud";
    
    :Esperar respuesta del m√©dico;
    
    if (¬øM√©dico responde en 7 d√≠as?) then (No)
      :Solicitud expira;
      :Notificaci√≥n al usuario:
      "Tu solicitud expir√≥.
      Intenta comunicarte directamente
      con tu m√©dico";
      stop
    endif
    
    if (¬øM√©dico acepta?) then (S√≠)
      :Notificaci√≥n push:
      "üéâ Dr./Dra. [Nombre] acept√≥
      tu solicitud de vinculaci√≥n";
      
      :Activar compartici√≥n de datos;
      :Iniciar sincronizaci√≥n autom√°tica;
      
      :Pantalla Confirmaci√≥n Final;
      :Mostrar mensaje:
      "‚úì Vinculaci√≥n exitosa
      
      Tu m√©dico ahora puede ver:
      - Tu adherencia medicamentos
      - Tu historial de tomas
      - Tus estad√≠sticas generales
      
      Tu m√©dico NO puede:
      - Modificar tus medicamentos
      - Ver tus datos personales completos
      - Acceder sin tu consentimiento";
      
      :Badge "M√©dico vinculado" en perfil;
      
    else (Rechaza)
      :Notificaci√≥n:
      "Dr./Dra. [Nombre] no pudo
      aceptar tu solicitud";
      
      if (¬øM√©dico dej√≥ nota?) then (S√≠)
        :Mostrar raz√≥n del rechazo;
      endif
      
      :Sugerir:
      - Verificar datos con m√©dico
      - Intentar nuevamente
      - Contactar cl√≠nica;
      stop
    endif
  }
  
else (No tiene c√≥digo)
  partition "Flujo sin C√≥digo" {
    :Pantalla "No tengo c√≥digo";
    
    :Explicaci√≥n:
    "Tu m√©dico debe generar un c√≥digo
    desde su dashboard MediMind
    para que puedas vincularte";
    
    :Generar plantilla de mensaje;
    :Mensaje pre-escrito:
    "Hola Doctor/a,
    
    Estoy usando MediMind para gestionar
    mis medicamentos y me gustar√≠a vincular
    mi cuenta con usted para que pueda
    monitorear mi adherencia.
    
    ¬øPodr√≠a generarme un c√≥digo de
    vinculaci√≥n desde su dashboard MediMind?
    
    Gracias,
    [Nombre Usuario]";
    
    :Opciones de env√≠o;
    
    if (¬øMedio de contacto?) then (WhatsApp)
      :Abrir WhatsApp con mensaje;
      :Usuario selecciona contacto m√©dico;
      :Enviar mensaje;
      
    elseif (Email) then
      :Abrir cliente email;
      :Pre-llenar asunto y cuerpo;
      :Usuario env√≠a email;
      
    elseif (SMS) then
      :Abrir mensajes;
      :Pre-llenar mensaje;
      :Usuario env√≠a SMS;
      
    else (Copiar)
      :Copiar mensaje al portapapeles;
      :Confirmaci√≥n:
      "‚úì Mensaje copiado
      P√©galo en tu app preferida";
    endif
    
    :Regresar a pantalla vinculaci√≥n;
    :Instrucciones:
    "Cuando tu m√©dico te env√≠e el c√≥digo,
    vuelve aqu√≠ e ingr√©salo";
  }
endif

partition "Gesti√≥n Post-Vinculaci√≥n" {
  :Usuario en Perfil;
  :Secci√≥n "M√©dico vinculado";
  
  :Tarjeta del m√©dico;
  :Opciones disponibles:
  - Ver datos compartidos
  - Pausar compartici√≥n
  - Desvincular;
  
  if (¬øAcci√≥n seleccionada?) then (Ver datos)
    :Mostrar qu√© se comparte:
    ‚úì Adherencia general (%)
    ‚úì Historial √∫ltimos 30 d√≠as
    ‚úì Lista medicamentos activos
    ‚úì Alertas de no cumplimiento
    
    ‚úó Datos personales completos
    ‚úó Fotos personales
    ‚úó Notas privadas;
    
  elseif (Pausar) then
    :Confirmaci√≥n:
    "¬øPausar compartici√≥n?
    Tu m√©dico no ver√° actualizaciones
    hasta que reactives";
    
    if (¬øConfirma?) then (S√≠)
      :Pausar sincronizaci√≥n;
      :Notificar al m√©dico;
      :Mostrar estado "Pausado";
    endif
    
  else (Desvincular)
    :Advertencia:
    "‚ö†Ô∏è ¬øDesvincular de Dr./Dra. [Nombre]?
    
    Esta acci√≥n:
    - Detendr√° compartici√≥n de datos
    - Notificar√° a tu m√©dico
    - NO borrar√° tu historial
    
    ¬øContinuar?";
    
    if (¬øConfirma desvinculaci√≥n?) then (S√≠)
      :Solicitar raz√≥n (opcional):
      - Cambio de m√©dico
      - Ya no necesito seguimiento
      - Problemas de privacidad
      - Otro;
      
      :Desvincular;
      :Notificar al m√©dico;
      :Detener sincronizaci√≥n;
      
      :Confirmaci√≥n:
      "‚úì Desvinculaci√≥n exitosa
      Tu historial se mantiene privado";
    endif
  endif
}

:Control total del paciente;
note right
  El paciente SIEMPRE tiene
  control total sobre:
  - Con qui√©n comparte
  - Qu√© comparte
  - Cu√°ndo pausar
  - Cu√°ndo desvincular
end note

stop

@enduml
