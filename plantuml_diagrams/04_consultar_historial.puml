@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam activityBackgroundColor #F3E5F5
skinparam activityBorderColor #7B1FA2
skinparam activityFontSize 12
skinparam arrowColor #7B1FA2

title Flujo 4: Consultar Historial - App M√≥vil

start

:Usuario en Home;
:Tap "Historial" en barra navegaci√≥n;

:Pantalla Historial Adherencia;
:Mostrar por defecto:
- Vista calendario mes actual
- % adherencia general
- Gr√°fico de tendencia;

partition "Visualizaci√≥n de Datos" {
  :Calendario con marcadores:
  ‚úì D√≠as completos (verde)
  ‚è∞ D√≠as con retrasos (amarillo)
  ‚úó D√≠as con faltas (rojo)
  ‚óã D√≠as saltados (gris);
  
  :% Adherencia mostrado como:
  - N√∫mero grande (95%)
  - Barra de progreso
  - C√≥digo color (Verde/Amarillo/Rojo);
  
  :Gr√°fico de tendencia (√∫ltimos 30 d√≠as):
  - L√≠nea de adherencia
  - Promedio m√≥vil
  - Meta objetivo (80%);
}

if (¬øUsuario toca d√≠a espec√≠fico?) then (S√≠)
  :Expandir detalles del d√≠a;
  :Mostrar lista de medicamentos:
  - Hora programada
  - Hora real de toma
  - Estado (A tiempo/Tarde/No tomado)
  - Diferencia en minutos;
  
  if (¬øUsuario toca medicamento espec√≠fico?) then (S√≠)
    :Mostrar modal con detalles:
    - Nombre medicamento
    - Dosis tomada
    - Timestamp exacto
    - Notas si existen
    - Foto si existe;
    
    if (¬øUsuario quiere editar?) then (S√≠)
      :Advertencia:
      "Editar registros hist√≥ricos
      requiere justificaci√≥n";
      
      :Solicitar nota explicativa;
      :Marcar registro como "Editado por usuario";
      :Guardar timestamp de edici√≥n;
      :Actualizar registro;
    endif
  endif
endif

partition "Filtros y B√∫squeda" {
  :Usuario puede aplicar filtros;
  
  if (¬øFiltro seleccionado?) then (Rango de fechas)
    :Selector de fechas:
    - √öltima semana
    - √öltimo mes
    - √öltimos 3 meses
    - Personalizado;
    
    :Actualizar vista calendario;
    :Recalcular estad√≠sticas;
    
  elseif (Por medicamento espec√≠fico) then
    :Lista de medicamentos activos;
    :Usuario selecciona uno o varios;
    
    :Filtrar historial solo
    para medicamentos seleccionados;
    
    :Mostrar estad√≠sticas espec√≠ficas:
    - % adherencia por medicamento
    - Patr√≥n de tomas
    - Horas promedio de toma;
    
  elseif (Por estado) then
    :Opciones:
    - Solo tomados
    - Solo retrasados
    - Solo no tomados
    - Solo saltados;
    
    :Aplicar filtro;
    :Actualizar vista;
  endif
}

partition "An√°lisis y Estad√≠sticas" {
  :Usuario scrollea a secci√≥n estad√≠sticas;
  
  :Mostrar tarjetas informativas:
  
  CARD 1: Adherencia Global
  - % total
  - Tendencia (‚Üë ‚Üì ‚Üí)
  - Comparaci√≥n mes anterior;
  
  CARD 2: Racha Actual
  - D√≠as consecutivos sin faltas
  - Mejor racha hist√≥rica
  - Motivaci√≥n visual (üî•);
  
  CARD 3: Medicamentos
  - Total activos
  - Mejor adherencia
  - Necesita atenci√≥n;
  
  CARD 4: Horarios
  - Hora m√°s cumplida
  - Hora m√°s problem√°tica
  - Sugerencias;
}

partition "Exportar Reporte" {
  :Usuario tap "Exportar";
  
  :Modal configuraci√≥n reporte;
  :Usuario selecciona:
  - Rango de fechas
  - Medicamentos a incluir
  - Incluir estad√≠sticas (S√≠/No)
  - Incluir gr√°ficos (S√≠/No)
  - Formato (PDF/Excel);
  
  if (¬øConfirma exportaci√≥n?) then (S√≠)
    :Generando reporte...;
    :Crear documento con:
    - Encabezado (nombre, fecha)
    - Tabla de adherencia
    - Gr√°ficos visuales
    - Notas relevantes
    - Pie de p√°gina (generado por MediMind);
    
    :Modal opciones de compartir;
    
    if (¬øAcci√≥n?) then (Enviar a m√©dico vinculado)
      :Enviar autom√°ticamente
      al dashboard del m√©dico;
      :Confirmar env√≠o;
      
    elseif (Compartir por) then
      :Abrir selector de apps:
      - Email
      - WhatsApp
      - Drive
      - Otras;
      
    else (Guardar en dispositivo)
      :Guardar en carpeta
      /Documentos/MediMind/;
      :Mostrar ubicaci√≥n;
    endif
    
    :Confirmaci√≥n:
    ‚úì "Reporte exportado exitosamente";
  endif
}

:Regresar a pantalla historial;
stop

@enduml
